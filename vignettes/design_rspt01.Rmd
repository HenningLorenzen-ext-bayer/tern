---
title: "Design: Best overall response (RSPT01)"
author: "Francois Collin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{design_rspt01}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/REFERENCES.bib

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```


Configuration
=============

```{r setup}
library(rtables)
library(tern)

packageVersion("tern")
packageVersion("rtables")
```

Execution
=========

Estimate proportion {.tabset}
-----------------------------

### Application

```{r estimate_proportion}
dta_test <- data.frame(X = c(1, 0, 1, 0))
l <- estimate_proportion(lyt = NULL, vars = "X")

build_table(lyt = l, df = dta_test)
```

```{r s_proportion}
s_proportion(c(1, 0, 1, 0))
```

### Functions

- `prop_wilson()`
- `prop_clopper_pearson()`
- `prop_wald()`
- `prop_agresti_coull()`
- `prop_jeffreys()`
- `s_proportion()`
- `estimate_proportion()`
- `d_proportion()`

```{r estimate_proportion.R, engine='bash', comment=''}
cat ../R/estimate_proportion.R
```


Estimate proportion differences {.tabset}
-----------------------------------------

### Application

```{r estimate_proportion_diff_app}
# Wald confidence interval

set.seed(2)
rsp <- sample(c(TRUE, FALSE), replace = TRUE, size = 20)
grp <- c(rep("A", 10), rep("B", 10))
prop_diff_wald(rsp = rsp, grp = grp, conf_level = 0.90, correct = FALSE)

# Anderson-Hauck confidence interval

## "Mid" case: 3/4 respond in group A, 1/2 respond in group B.
rsp <- c(TRUE, FALSE, FALSE, TRUE, TRUE, TRUE)
grp <- factor(c("A", "B", "A", "B", "A", "A"), levels = c("B", "A"))
prop_diff_ha(rsp = rsp, grp = grp, conf_level = 0.90)

## Edge case: Same proportion of response in A and B.
rsp <- c(TRUE, FALSE, TRUE, FALSE)
grp <- factor(c("A", "A", "B", "B"), levels = c("A", "B"))
prop_diff_ha(rsp = rsp, grp = grp, conf_level = 0.6)


# Newcombe confidence interval

set.seed(1)
rsp <- c(
  sample(c(TRUE, FALSE), size = 40, prob = c(3/4, 1/4), replace = TRUE),
  sample(c(TRUE, FALSE), size = 40, prob = c(1/2, 1/2), replace = TRUE)
)
grp <- factor(rep(c("A", "B"), each = 40), levels = c("B", "A"))
table(rsp, grp)
prop_diff_nc(rsp = rsp, grp = grp, conf_level = 0.9)


# Cochran-Mantel-Haenszel confidence interval

set.seed(2)
rsp <- sample(c(TRUE, FALSE), 100, TRUE)
grp <- sample(c("Placebo", "Treatment"), 100, TRUE)
grp <- factor(grp, levels = c("Placebo", "Treatment"))
strata_data <- data.frame(
  "f1" = sample(c("a", "b"), 100, TRUE),
  "f2" = sample(c("x", "y", "z"), 100, TRUE),
  stringsAsFactors = TRUE)

prop_diff_cmh(
  rsp = rsp, grp = grp, strata = interaction(strata_data),
  conf_level = 0.90
)


# Summary

## "Mid" case: 4/4 respond in group A, 1/2 respond in group B.
dta <- data.frame(
  rsp = c(TRUE, FALSE, FALSE, TRUE, TRUE, TRUE),
  grp = factor(c("A", "B", "A", "B", "A", "A"), levels = c("B", "A"))
)

s_proportion_diff(
  df = subset(dta, grp == "A"),
  .var = "rsp",
  .ref_group = subset(dta, grp == "B"),
  .in_ref_col = FALSE,
  conf_level = 0.90,
  method = "ha"
)


l <- split_cols_by(lyt = NULL, var = "grp", ref_group = "B") %>%
  estimate_proportion_diff(
    vars = "rsp",
    conf_level = 0.90,
    method = "ha"
  )

build_table(l, df = dta)

```

### Functions

- `check_diff_prop_ci()`
- `d_proportion_diff()`
- `prop_diff_wald()`
- `prop_diff_ha()`
- `prop_diff_nc()`
- `prop_diff_cmh()`
- `s_proportion_diff()`
- `estimate_proportion_diff()`

```{r prop_diff.R, engine='bash', comment=''}
cat ../R/prop_diff.R
```


Test proportion difference {.tabset}
------------------------------------

### Application

```{r}
dta <- data.frame(
  rsp = sample(c(TRUE, FALSE), 100, TRUE),
  grp = factor(rep(c("A", "B"), each = 50)),
  strat = factor(rep(c("V", "W", "X", "Y", "Z"), each = 20))
)

s_test_proportion_diff(
  df = subset(dta, grp == "A"),
  .var = "rsp",
  .ref_group = subset(dta, grp == "B"),
  .in_ref_col = FALSE,
  variables = list(strata = "strat"),
  method = "cmh"
)

l <- split_cols_by(lyt = NULL, var = "grp", ref_group = "B") %>%
  test_proportion_diff(
    vars = "rsp",
    method = "cmh", variables = list(strata = "strat")
  )

build_table(l, df = dta)

```

### Functions

- `prop_chisq()`
- `prop_cmh()`
- `prop_schouten()`
- `prop_fisher()`
- `s_test_proportion_diff()`
- `d_test_proportion_diff()`
- `test_proportion_diff()`

```{r test_proportion_diff.R, engine='bash', comment=''}
cat ../R/test_proportion_diff.R
```

Estimate Odds Ratio {.tabset}
-----------------------------

### Application

```{r}
dta <- data.frame(
  rsp = sample(c(TRUE, FALSE), 100, TRUE),
  grp = factor(rep(c("A", "B"), each = 50))
)

l <- split_cols_by(lyt = NULL, var = "grp", ref_group = "B") %>%
  estimate_odds_ratio(vars = "rsp")

build_table(l, df = dta)
```

### Functions

- `or_glm()`
- `s_odds_ratio()`
- `estimate_odds_ratio()`

```{r odds_ratio.R, engine='bash', comment=''}
cat ../R/odds_ratio.R
```

### Limits

#### `or_clogit` - wrong implementation

```{r}
library(survival)
#' OR with Strata by Conditional Likelihood
#'
#' The odds ratio is estimated by conditional likelihood using
#' [survival::clogit()].
#'
#' @inheritParams argument_convention
#' @param data (`data frame`)\cr
#'   includes the three variables `rsp`, `grp` and `strata`.
#' @importFrom survival strata clogit coxph
or_clogit <- function(data, conf_level) {

  # Deviation from convention: `survival::strata` must be simply `strata`.
  formula <- stats::as.formula("rsp ~ grp + strata(strata)")
  model_fit <- survival::clogit(formula = formula, data = data)

  list(
    or_ci = c(
      exp(stats::coef(model_fit)),
      exp(stats::confint(model_fit, level = conf_level))
    )
  )

}
```

The `clogit`-based prototype is flawed as the OR estimates obtained for a
model fitted on data subset is not equivalent to the estimates based on the
complete dataset. This is typically the case of `rtables` workflow working
by column (eventually in comparison to a reference):

```{r}
data <- data.frame(
  rsp = as.logical(c(1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0)),
  grp =    letters[c(1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3)],
  strata = LETTERS[c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2)]
)

data <- subset(data, grp %in% c("a", "b"))
data$grp <- droplevels(data$grp)
or_clogit(data, conf_level = 0.95)

data <- data.frame(
  rsp = as.logical(c(1, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 0)),
  grp =    letters[c(1, 1, 1, 2, 2, 2, 3, 3, 3, 3, 1, 1, 1, 2, 2, 2, 3, 3, 3, 3)],
  strata = LETTERS[c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2)]
)

data$grp <- droplevels(data$grp)
or_clogit(data, conf_level = 0.95)
```


Estimate multinomial response
-----------------------------

### Application

```{r}
dta_test <- data.frame(
  USUBJID = paste0("S", 1:12),
  ARM     = rep(LETTERS[1:3], each = 4),
  AVAL    = c(A = c(1, 1, 1, 1), B = c(0, 0, 1, 1), C = c(0, 0, 0, 0))
)
dta_test$AVALC <- as.factor(c(
  "Complete Response (CR)", "Partial Response (PR)"
)[dta_test$AVAL + 1])

lyt <- split_cols_by(lyt = NULL, var = "ARM") %>%
  estimate_multinomial_response(var = "AVALC")

build_table(lyt = lyt, df = dta_test)
```

### Functions

- `d_onco_rsp_label()`
- `h_prop_ci()`
- `s_multinomial_response()`
- `estimate_multinomial_response()`

```{r estimate_multinomial_rsp.R, engine='bash', comment=''}
cat ../R/estimate_multinomial_rsp.R
```

Stacked layers
==============

```{r}
# Preparation of the test case.
library(dplyr)
library(random.cdisc.data)
adsl <- radsl(cached = TRUE)
adrs <- radrs(cached = TRUE)

# Select a response parameter endpoint.
adrs <- adrs %>% filter(PARAMCD == "INVET")

# Recode multinomial response with standard oncology labels.
levels(adrs$AVALC) <- d_onco_rsp_label(levels(adrs$AVALC))

# Response variable.
adrs <- adrs %>%
  select(ARMCD, AVALC, SEX, STRATA1, STRATA2) %>%
  mutate(
    is_rsp = AVALC %in% c("Complete Response (CR)", "Partial Response (PR)")
  )

l <- split_cols_by(lyt = NULL, var = "ARMCD", ref_group = "ARM A") %>%
  add_colcounts() %>%
  estimate_proportion(vars = "is_rsp") %>%
  estimate_proportion_diff(
    vars = "is_rsp", show_labels = "visible",
    var_labels = "Unstratified Analysis"
  ) %>%
  test_proportion_diff(vars = "is_rsp", method = "schouten") %>%
  estimate_odds_ratio(vars = "is_rsp") %>%
  estimate_multinomial_response(var = "AVALC")

build_table(l, adrs) %>% as_html
```

Design Propositions
===================

Refactor of `prop_schouten` [@Schouten1980]
---------------------------

```{r}
library(testthat)
library(assertthat)
## Data
A <- 20
B <- 20
set.seed(1)
rsp <- c(
  sample(c(TRUE, FALSE), size = A, prob = c(3/4, 1/4), replace = TRUE),
  sample(c(TRUE, FALSE), size = A, prob = c(1/2, 1/2), replace = TRUE)
)
grp <- c(rep("A", A), rep("B", B))
tbl <- table(grp, rsp)

prop_schouten <- function(tbl) {

  assert_that(ncol(tbl) == 2, nrow(tbl) == 2)

  # Source: STREAM v2
  #nolint start
  # https://onlinelibrary.wiley.com/doi/epdf/10.1002/bimj.4710220305
  #nolint end
  tbl <- tbl[, c("TRUE", "FALSE")]

  n <- sum(tbl)

  ad <- diag(tbl)
  bc <- diag(apply(tbl,2,rev))
  ac <- tbl[,1]
  bd <- tbl[,2]

  n1 <- sum(tbl[1,])
  n2 <- sum(tbl[2,])

  t_schouten <- (n - 1) *
    (abs(prod(ad) - prod(bc)) - 0.5 * min(n1, n2))^2 /
    (n1 * n2 * sum(ac) * sum(bd))

  1 - stats::pchisq(t_schouten, df = 1)
}

## Chi-Squared test + Schouten correction.
expect_equal(prop_schouten(tbl), 0.08434269, tolerance = 1e-6)
```

References
==========
