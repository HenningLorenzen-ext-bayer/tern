---
title: "Design: Laboratory Test Results by Visit (LBT02)"
author: "Francois Collin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{design_lbt02}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/REFERENCES.bib

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Summary
=======

Targets:

- test candidate design as LBT02.
- use of `format_wrap_x`.

Specifications:

+ GDSR [@Hughes2020].
+ STREAM [@STREAM_LBT02]

Plan:

- [x] low level summary function `s_summary`:
    + method for numerics.
    + test of `s_summary.numerics` as a statistical function.
- [x] high level function `summarize_vars`
    + find an alternative name as already existing within `dplyr`.
    + depends on `format_wrap_x` in Daniel's branch.
    + test as an *analyzes* function
- [ ] table function test: `table-test_lbt02.R`
- [ ] Optional: push a `fmt()` (equivalent to `xxx()`) function?

Configuration
=============

Dependencies:

- Depends on rtables.
- `format_wrap_x` from Daniel' s branch.

```{r setup}
library(rtables)
library(tern)

packageVersion("rtables")
packageVersion("tern")
# vignette("design_lbt02")
```

Depends on lab test analysis dataset (ADLB). The template is supposed to be
applied to a single analyzed parameter (PARAMCD). For the example, the 
screening data were removed. The sample size varies from a sample to another
(e.g. missed test) and "N" is based on the number of subject included in the
trial as defined by the subject level analysis dataset (ADSL).

```{r data}
adlb <- subset(ex_adlb, AVISIT != "SCREENING" & PARAMCD == "ALT")
clcnt <- table(unique(ex_adsl[c("USUBJID", "ARMCD")])$ARMCD)
```

Prototype
=========

Outline  {.tabset}
------------------

The template LBT02 is a numerical description of a laboratory test
(initial data subset)
for every combination of study arms (in columns, `rtables::split_cols_by`)
and visits (in rows, `rtables::split_rows_by`).
The intersection of a row and a column defines a subset of data (`x`
generally corresponding to `AVAL`) ordinarily described by:

- `n`, the number of realized tests;
- `Mean (SD)`, mean and standard deviation;
- `Median`;
- `Min - Max`, the range of values from the minimum to the maximum.

From the execution standpoint, a layout function `summarize_vars`
insure the analyzes. It is a wrapper for `rtables::analyze`, extra arguments
(`extra_args`) are used:

- for fine tuning: describing the statistic selection
(`.stats` to choose among `n`, `mean_sd`, `median`, `range`),
the associated formats
(`.formats`, named list corresponding to `.stats` selection)
and labels (`.labels`, named list corresponding to `.stats`).
- other arguments are conveyed to/interpreted by
the statistical function `s_summary(.numeric)` where lives the analysis.

### Functions {.tabset .tabset-pills}

For the higher level function, as of wrapper, I suggest not to be shy
proposing specialized named functions, as soon as they rely on
a common foundation.

#### S3 generic/method `s_summary` and `summarize_vars`

```{r summarize_variables.R, engine='bash', comment=''}
cat ../R/summarize_variables.R
```

### Application {.tabset .tabset-pills}

#### Fabricated data

```{r}
# Fabricated dataset.
dta_test <- data.frame(
  USUBJID = rep(1:6, each = 3),
  PARAMCD = rep("lab", 6*3),
  AVISIT  = rep(paste0("V", 1:3), 6),
  ARM     = rep(LETTERS[1:3], rep(6, 3)),
  AVAL    = c(9:1, rep(NA, 9))
)

# Default output within a `rtables` pipeline.
l <- split_cols_by(lyt = NULL, var = "ARM") %>%
  split_rows_by(var = "AVISIT") %>%
  summarize_vars(vars = "AVAL")

build_table(l, df = dta_test)

# Select and format statistics output.
l <- split_cols_by(lyt = NULL, var = "ARM") %>%
  split_rows_by(var = "AVISIT") %>%
  summarize_vars(
    vars = "AVAL",
    .stats = c("n", "mean_sd"),
    .formats = c("mean_sd" = "xx.x, xx.x"),
    .labels = c(n = "n", mean_sd = "Mean (SD)")
  )

results <- build_table(l, df = dta_test)
as_html(results)

# Use arguments interpreted by `s_summary`.
l <- split_cols_by(lyt = NULL, var = "ARM") %>%
  split_rows_by(var = "AVISIT") %>%
  summarize_vars(vars = "AVAL", na.rm = FALSE)

results <- build_table(l, df = dta_test)
as_html(results)

```

#### `RCD` (TODO)

References
==========
