---
title: "Design for helper function to create layout map in LBT13/14"
author: "Rosemary Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: journal
    highlight: zenburn
vignette: >
  %\VignetteIndexEntry{Design of LBT04/VST02/EGT02/LBT15}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svg"
)
```

Configuration
=============

```{r setup}
library(rtables)
library(tern)
library(dplyr)
library(assertthat)
library(checkmate)

packageVersion("tern")
packageVersion("rtables")
```

Introduction
=============

When templates like LBT13 and 14 were refactored using `trim_levels_to_map`, we would like to have some helper function
for users to easily create the correct map. The metadata used to create the map can be found at
metadata/__atoxgr_allhigh_ref.sas7bdat

Design
=============

New function to store meta data.
```{r eval=FALSE}
d_atoxgr_allhigh_ref <- function() {
  atoxgr_allhigh_ref <- as.data.frame(
    matrix(c(
      "ALKPHSI",  "1", "ALKPHSI",  "2", "ALKPHSI",  "3", "ALKPHSI",  "4", "ALKPHSI",  "Not High",
      "ALTSI",    "1", "ALTSI",    "2", "ALTSI",    "3", "ALTSI",    "4", "ALTSI",    "Not High",
      "AMYLASSI",    "1", "AMYLASSI",    "2", "AMYLASSI",    "3", "AMYLASSI",    "4", "AMYLASSI",    "Not High",
      "ASTSI",    "1",  "ASTSI",    "2", "ASTSI",    "3", "ASTSI",    "4", "ASTSI",    "Not High",
      "CALCUMSI",    "1", "CALCUMSI",    "2", "CALCUMSI",    "3", "CALCUMSI",    "4", "CALCUMSI",    "Not High",
      "CH0022SI",    "1", "CH0022SI",    "2", "CH0022SI",    "3", "CH0022SI",    "4", "CH0022SI",    "Not High",
      "CH0350SI",    "1", "CH0350SI",    "2", "CH0350SI",    "3", "CH0350SI",    "4", "CH0350SI",    "Not High",
      "CH0365SI",    "1", "CH0365SI",    "2", "CH0365SI",    "3", "CH0365SI",    "4", "CH0365SI",    "Not High",
      "CH0467SI",    "1", "CH0467SI",    "2", "CH0467SI",    "3", "CH0467SI",    "4", "CH0467SI",    "Not High",
      "CHOLESSI",    "1", "CHOLESSI",    "2", "CHOLESSI",    "3", "CHOLESSI",    "4", "CHOLESSI",    "Not High",
      "CPKSI",    "1", "CPKSI",    "2", "CPKSI",    "3",  "CPKSI",    "4",  "CPKSI",    "Not High",
      "CREATNSI",    "1", "CREATNSI",    "2", "CREATNSI",    "3", "CREATNSI",    "4", "CREATNSI",    "Not High",
      "FASTGLSI",    "1", "FASTGLSI",    "2", "FASTGLSI",    "3", "FASTGLSI",    "4", "FASTGLSI",    "Not High",
      "GGTSI",    "1",
      "GGTSI",    "2",
      "GGTSI",    "3",
      "GGTSI",    "4",
      "GGTSI",    "Not High",
      "GLUCSI",    "3",
      "GLUCSI",    "4",
      "GLUCSI",    "Not High",
      "HGBSI",    "1",
      "HGBSI",    "2",
      "HGBSI",    "3",
      "HGBSI",    "Not High",
      "LIPASESI",    "1",
      "LIPASESI",    "2",
      "LIPASESI",    "3",
      "LIPASESI",    "4",
      "LIPASESI",    "Not High",
      "LYMPHSI",    "2",
      "LYMPHSI",    "3",
      "LYMPHSI",    "Not High",
      "MAGNESSI",    "1",
      "MAGNESSI",    "3",
      "MAGNESSI",    "4",
      "MAGNESSI",    "Not High",
      "POTASSI" ,    "1",
      "POTASSI" ,    "2",
      "POTASSI" ,    "3",
      "POTASSI" ,    "4",
      "POTASSI" ,    "Not High",
      "PTINRSI",    "1",
      "PTINRSI",    "2",
      "PTINRSI",    "3",
      "PTINRSI",    "Not High",
      "PTTSI",    "1",
      "PTTSI",    "2",
      "PTTSI",    "3",
      "PTTSI",    "Not High",
      "SODIUMSI",    "1",
      "SODIUMSI",    "2",
      "SODIUMSI",    "3",
      "SODIUMSI",    "4",
      "SODIUMSI",    "Not High",
      "TBILISI",    "1",
      "TBILISI",    "2",
      "TBILISI",    "3",
      "TBILISI",    "4",
      "TBILISI",    "Not High",
      "TRIGSI",    "1",
      "TRIGSI",    "2",
      "TRIGSI",    "3",
      "TRIGSI",    "4",
      "TRIGSI",    "Not High",
      "URACIDSI",    "3",
      "URACIDSI",    "4",
      "URACIDSI",    "Not High",
      "WBCSI",    "3",
      "WBCSI",    "Not High"
    ),
    ncol = 2,
    byrow = TRUE)
  )
  colnames(atoxgr_allhigh_ref) <- c("PARAMCD", "ATOXGR")
  atoxgr_allhigh_ref
}
```

New helper function to create grouping and map? Or it's easier to separate grouping and map?
```{r}
h_toxicity_grade_group <- function(
    df, 
    variables = c("ATOXGR", "BTOXGR"), 
    grouping = list("Not High" = c(0, -1, -2, -3, -4), "1" = 1, "2" = 2, "3" = 3, "4" = 4, "Missing" = "<Missing>")) {
  for (variable in variables) {
    new_var <- paste0(variable, "_GP")
    df[[new_var]] <- NA
    for (i in names(grouping)) {
      df[[new_var]] <- ifelse(df[[variable]] %in% unname(grouping[i])[[1]], i, df[[new_var]])
    }
  }
  df
}

h_toxicity_grade_map <- function(
    paramcds = c("ALKPHSI", "GLUCSI"), 
    ref = d_atoxgr_allhigh_ref(), 
    missing_level = "Missing",
    var_group = c("BTOXGR_GP", "ATOXGR_GP")) {
  ref_sub <- ref %>% filter(PARAMCD %in% paramcds)
  result_df <- data.frame()
  for (paramcd in paramcds) {
    a <- paramcd
    b <- ref_sub %>% filter(PARAMCD == paramcd) %>% pull("ATOXGR")
    b <- c(b, missing_level)
    c <- b
    paramcd_df <- expand.grid(a,b,c)
    colnames(paramcd_df) <- c("PARAMCD", var_group)
    result_df <- rbind(result_df, paramcd_df)
  }
  
  result_df
}
```



Unit tests
=============
```{r eval=FALSE}
ATOXGR <- c(0, 2, 3, 4, -3)
BTOXGR <- c(-1, -3, 0, 3 ,2)
df <- data.frame(ATOXGR, BTOXGR)
h_toxicity_grade_group(df)
```
